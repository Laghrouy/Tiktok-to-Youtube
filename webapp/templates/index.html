<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TikTok ‚Üí YouTube (Local)</title>
    <link rel="icon" href="/static/favicon.ico" />
    <!-- CSS: Tailwind compil√© si pr√©sent, sinon fallback app.css -->
    <link id="tw_css" rel="stylesheet" href="/static/build/app.css" onload="document.documentElement.classList.add('tw');" onerror="this.parentNode.removeChild(this)" />
    <style>
      :root{ --bg:#0b0e13; --bg2:#0a0c12; --card: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.08); --text:#e8eaf0; --muted:#98a2b3; --acc1:#7c3aed; --acc2:#2563eb; --acc3:#06b6d4; }
      html { scroll-behavior: smooth; }
      body { background: radial-gradient(1200px 600px at -10% -10%, rgba(124,58,237,0.12), transparent 60%), radial-gradient(1000px 500px at 110% -20%, rgba(37,99,235,0.10), transparent 60%), linear-gradient(180deg, #0b1220, #0a0f1d); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; }
      .wrap { max-width: 1060px; margin: 24px auto 60px; padding: 0 16px; }
      .hero { background: linear-gradient(135deg, rgba(124,58,237,0.25), rgba(37,99,235,0.25)); border: 1px solid var(--border); border-radius: 14px; padding: 16px 18px; margin-bottom: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); backdrop-filter: blur(8px); }
      h1 { margin: 0; font-size: 22px; letter-spacing: .3px; }
      p.lead { margin: 6px 0 0; color: var(--muted); }
      .card{ background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin: 16px 0; box-shadow: 0 8px 24px rgba(0,0,0,0.25); backdrop-filter: blur(8px); }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .mt-2 { margin-top: 12px; } .mt-3 { margin-top: 20px; }
      h2 { margin: 0 0 10px; font-size: 16px; font-weight: 600; color: #dbe3ff; }
      .preview { max-width: 360px; max-height: 220px; display: block; border-radius: 8px; border: 1px solid var(--border); }
  .bar { width: 100%; max-width: 100px; height: 10px; background: rgba(255,255,255,0.06); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
      .bar > .fill { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); width: 0%; transition: width .35s; box-shadow: 0 0 10px rgba(34,197,94,0.3) inset; }
      .hint { color: var(--muted); font-size: 12px; }
      .wm-thumb { max-height: 40px; border: 1px solid var(--border); border-radius: 6px; background: rgba(255,255,255,0.04); }
      .muted { color: var(--muted); }
      .nav { position: sticky; top: 0; z-index: 10; background: rgba(10,12,18,0.65); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); }
      .nav-inner { max-width: 1060px; margin: 0 auto; padding: 10px 16px; display:flex; align-items:center; justify-content: space-between; }
      .nav-brand { font-weight: 600; letter-spacing:.2px; }
  .chip { display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,0.06); border:1px solid var(--border); color:#dbe3ff; padding:6px 10px; border-radius:999px; font-size:12px; }
  .chip-active{ background: linear-gradient(135deg, rgba(124,58,237,0.35), rgba(37,99,235,0.35)); border-color: rgba(124,58,237,0.45); color:#ffffff; }
      .btn-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background: rgba(255,255,255,0.06); color:#e9edff; cursor:pointer; }
  .btn-chip-violet{ border:0; background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white; box-shadow: 0 6px 18px rgba(124,58,237,0.25); }
  .btn-chip-violet:hover{ filter: brightness(1.05); }
      .btn-gradient{ padding:8px 14px; border-radius:10px; border:0; background:linear-gradient(135deg, #7c3aed, #2563eb); color:white; cursor:pointer; }
      .secondary{ padding:6px 10px; border-radius:8px; background: rgba(255,255,255,0.06); color:#e9edff; border:1px solid var(--border); cursor:pointer; }
      .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); }
      .badge-blue{ background:rgba(37,99,235,0.18); color:#cfe2ff; }
      .badge-violet{ background:rgba(124,58,237,0.18); color:#e0d4ff; }
      .badge-muted{ background:rgba(148,163,184,0.18); color:#e2e8f0; }
      .badge-live{ background:rgba(34,197,94,0.18); color:#d1fae5; }
      .toast { position: fixed; top: 16px; right: 16px; z-index: 9999; background: linear-gradient(135deg, rgba(124,58,237,0.35), rgba(37,99,235,0.35)); color: #e9edff; border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); backdrop-filter: blur(8px); opacity: 0; transform: translateY(-8px); transition: opacity .25s ease, transform .25s ease; }
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast a { color: #cfe2ff; text-decoration: none; }
      .toast a:hover { text-decoration: underline; }
      .toast .close { margin-left: 10px; cursor: pointer; opacity: .8; }
      .toast .close:hover { opacity: 1; }

      /* Fallback inputs if Tailwind utilities are missing */
      input[type="text"], input[type="number"], input[type="url"], input[type="search"], input[type="file"], input:not([type]), select, textarea {
        -webkit-appearance: none; appearance: none;
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        outline: none;
        max-width: 100%;
      }
      input::placeholder, textarea::placeholder { color: #94a3b8; }
      input:focus, select:focus, textarea:focus {
        border-color: rgba(139,92,246,0.6);
        box-shadow: 0 0 0 2px rgba(139,92,246,0.30), 0 0 0 1px rgba(139,92,246,0.60) inset;
      }
      input[type="checkbox"]{ width:16px; height:16px; accent-color:#7c3aed; }
      input[type="file"]{
        color:#cfe2ff;
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 8px;
      }
      /* Fallback for common utility-like widths */
      #ff_w, #ff_h { width: 120px; }
      #ff_trim_start, #ff_trim_end { width: 150px; }
      #pauseN_value { width: 80px; }
      /* Make wide text inputs actually expand on fallback */
      #q_url, #q_title, #q_desc, #q_proxy, #q_tags, #q_playlists, #inc_kw, #exc_kw, #ff_wm {
        flex: 1 1 420px; min-width: 300px;
      }
      .row > * { margin: 4px; }

      /* Sous-nav Harbor */
      .subnav{ position: sticky; top: 52px; z-index: 9; background: rgba(10,12,18,0.55); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); }
      .subnav-inner{ max-width: 1060px; margin: 0 auto; padding: 8px 16px; display:flex; gap:8px; overflow:auto; }

      /* Cards polish */
      .card{ transition: border-color .2s ease, box-shadow .2s ease, transform .06s ease; }
      .card:hover{ border-color: rgba(124,58,237,0.35); box-shadow: 0 10px 28px rgba(124,58,237,0.12); }
      .card h2{ position: relative; padding-left: 10px; }
      .card h2:before{ content:""; position:absolute; left:0; top:3px; bottom:3px; width:4px; border-radius:4px; background: linear-gradient(180deg, #7c3aed, #2563eb); opacity:.8; }

      /* Scrollbar custom (WebKit) */
      #logs::-webkit-scrollbar, #activity_list::-webkit-scrollbar{ height:10px; width:10px; }
      #logs::-webkit-scrollbar-thumb, #activity_list::-webkit-scrollbar-thumb{ background: linear-gradient(135deg, rgba(124,58,237,0.6), rgba(37,99,235,0.6)); border-radius: 999px; border: 2px solid rgba(11,14,19,0.6); }
      #logs::-webkit-scrollbar-track, #activity_list::-webkit-scrollbar-track{ background: rgba(255,255,255,0.06); border-radius: 999px; }

      /* Queue table: √©viter le d√©passement horizontal */
      #queue table { table-layout: fixed; width: 100%; }
      #queue th, #queue td { vertical-align: top; }
      /* Largeurs indicatives par colonne */
  #queue thead th:nth-child(1) { width: 18%; } /* URL */
  #queue thead th:nth-child(2) { width: 26%; } /* Titre */
  #queue thead th:nth-child(3) { width: 10%; } /* Statut */
  #queue thead th:nth-child(4),
  #queue thead th:nth-child(5),
  #queue thead th:nth-child(6) { width: 8%; }  /* F/D/U */
  #queue thead th:nth-child(7) { width: 10%; }  /* R√©sultat */
  #queue thead th:nth-child(8) { width: 5%; }  /* Ordre */
  #queue thead th:nth-child(9) { width: 5%; }  /* Actions */
      /* Cells: wrap pour longs textes */
  .wrap-cell { white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
  .url-cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .nowrap-ellipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #queue td:last-child { white-space: nowrap; }
      /* Emp√™cher d√©bordement visuel du wrapper */
      #queue .table-wrap { overflow-x: hidden; }
    </style>
  </head>
  <body>
    <nav class="nav">
      <div class="nav-inner">
        <div class="flex items-center gap-3">
          <span class="nav-brand text-lg">Harbor ‚Ä¢ T2Y</span>
          <span class="badge badge-muted">Local</span>
        </div>
        <div class="flex items-center gap-3">
          <a href="/" class="btn-chip">Accueil</a>
          <a href="/youtube" class="btn-chip">YouTube</a>
          <a href="/tiktok" class="btn-chip">TikTok</a>
        </div>
        <div class="nav-actions">
          <span id="css_badge" class="chip" title="Etat CSS">CSS: ‚Ä¶</span>
          <button class="btn-chip" onclick="checkFfmpeg()">FFmpeg</button>
          <button class="btn-chip" onclick="downloadDiagnostics()">Diagnostics</button>
        </div>
      </div>
    </nav>

    <div class="wrap">
      <div class="hero">
        <h1 class="text-xl">TikTok ‚Üí YouTube</h1>
        <p class="lead">Uploader local avec pr√©traitement ffmpeg et profils</p>
      </div>

      <!-- Sous-navigation (sections) -->
      <nav class="subnav">
        <div class="subnav-inner">
          <a href="#settings" class="chip">Param√®tres</a>
          <a href="#profiles" class="chip">Profils</a>
          <a href="#form" class="chip">Formulaire</a>
          <a href="#advanced" class="chip">Options</a>
          <a href="#queue" class="chip">File d‚Äôattente</a>
          <a href="#watch" class="chip">Surveillance</a>
          <a href="#journal" class="chip">Journal</a>
          <a href="#activity" class="chip">Activit√©</a>
        </div>
      </nav>

      <!-- Param√®tres g√©n√©raux (√©quivalents aux options globales) -->
  <section id="settings" class="card glass-card p-4">
      <h2>Param√®tres (g√©n√©raux)</h2>
      <div class="row">
        <label>Privacy:</label>
        <select id="s_privacy" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          <option value="public">public</option>
          <option value="unlisted">unlisted</option>
          <option value="private" selected>private</option>
        </select>
        <input id="s_profile" placeholder="Profil OAuth (default)" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <input id="s_timeout" type="number" placeholder="Timeout (s)" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
  <input id="s_proxy" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Proxy (ex: http://user:pass@host:port)" />
      </div>
      <div class="row">
        <input id="s_chunk" type="number" placeholder="Chunk MB" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <input id="s_retries" type="number" placeholder="Retries" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <button class="btn-gradient" onclick="saveSettings()">Enregistrer</button>
        <button class="btn-gradient" onclick="checkFfmpeg()">FFmpeg</button>
  <button class="btn-chip" onclick="downloadDiagnostics()">Exporter diagnostics</button>
  <button class="btn-chip" onclick="disconnectProfile()">D√©connecter</button>
  <button class="btn-chip" onclick="reauthProfile()">Re-auth</button>
      </div>
      </section>
    <!-- Profils (√©quivalent presets Tk) -->
  <section id="profiles" class="card glass-card p-4">
      <h2 class="mt-3">Profils</h2>
      <div class="row">
        <select id="prof_select" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60"></select>
  <button class="btn-chip" onclick="profileLoad()">Charger</button>
  <button class="btn-chip" onclick="profileSave()">Enregistrer</button>
  <button class="btn-chip" onclick="profileDuplicate()">Dupliquer</button>
  <button class="btn-chip" onclick="profileDelete()">Supprimer</button>
  <button class="btn-chip" onclick="profilesExport()">Exporter</button>
  <button class="btn-chip" onclick="profilesImport()">Importer</button>
      </div>
      </section>

    <!-- Formulaire principal (√©quivalent aux champs URL/Titre/Description + Pr√©remplir/Preview) -->
  <section id="form" class="card glass-card p-4">
      <h2 class="mt-3">Formulaire vid√©o</h2>
      <div class="row mt-2">
  <input id="q_url" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="URL TikTok" />
  <button class="btn-chip" onclick="prefill()">Pr√©remplir</button>
      </div>
      <div class="row">
  <input id="q_title" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Titre YouTube" />
      </div>
      <div class="row">
  <input id="q_desc" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Description" />
      </div>
      <div class="row">
        <img id="thumb" class="preview" alt="Miniature" />
      </div>
      </section>

    <!-- Options avanc√©es (tags/cat√©gorie/langue/licence/playlists/params upload) -->
  <section id="advanced" class="card glass-card p-4">
      <h2 class="mt-3">Options avanc√©es</h2>
      <div class="row">
  <input id="q_tags" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Tags (virgules)" />
      </div>
      <div class="row">
        <label>Privacy:</label>
        <select id="q_privacy" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          <option value="public">public</option>
          <option value="unlisted">unlisted</option>
          <option value="private" selected>private</option>
        </select>
        <select id="q_category" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          {% for name, cid in categories %}
            <option value="{{ cid }}">{{ name }}</option>
          {% endfor %}
        </select>
        <select id="q_language" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          {% for name, code in languages %}
            <option value="{{ code }}">{{ name }}</option>
          {% endfor %}
        </select>
        <select id="q_license" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          {% for name, code in licenses %}
            <option value="{{ code }}">{{ name }}</option>
          {% endfor %}
        </select>
      </div>
        <div class="row">
          <label>Destinations:</label>
          <label class="flex items-center gap-1 m-1"><input type="checkbox" id="dest_yt" class="accent-violet-500" checked/> <span>YouTube</span></label>
          <label class="flex items-center gap-1 m-1"><input type="checkbox" id="dest_ig" class="accent-violet-500"/> <span>Instagram</span></label>
          <label class="flex items-center gap-1 m-1"><input type="checkbox" id="dest_tt" class="accent-violet-500"/> <span>TikTok</span></label>
        </div>
      <div class="row">
  <input id="q_playlists" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Playlists (IDs, virgules)" />
      </div>
      <div class="row">
  <input id="q_proxy" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Proxy (ex: http://user:pass@host:port)" />
      </div>
      <div class="row">
        <input id="q_timeout" type="number" placeholder="Timeout upload (s)" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <input id="q_chunk" type="number" placeholder="Chunk MB" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <input id="q_retries" type="number" placeholder="Retries" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
        <input id="q_profile" placeholder="Profil OAuth (optionnel)" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
      </div>
      <!-- ffmpeg (l√©ger) -->
      <div class="row">
        <label>ffmpeg:</label>
        <select id="ff_mode" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          <option value="none">none</option>
          <option value="crop_9_16">crop_9_16</option>
          <option value="pad_9_16">pad_9_16</option>
        </select>
  <input id="ff_w" type="number" placeholder="W (ex 1080)" class="w-[120px] px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" oninput="whChanged('w')" onblur="validateWH()" />
  <input id="ff_h" type="number" placeholder="H (ex 1920)" class="w-[120px] px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" oninput="whChanged('h')" onblur="validateWH()" />
        <label class="flex items-center gap-1 m-1"><input type="checkbox" id="ff_normalize" class="accent-violet-500"/> <span>normalize</span></label>
        <label class="flex items-center gap-1 m-1"><input type="checkbox" id="ff_remux" class="accent-violet-500"/> <span>remux</span></label>
  <label class="flex items-center gap-1 m-1"><input type="checkbox" id="ff_force_916" class="accent-violet-500" onchange="validateWH()"/> <span>forcer 9:16</span></label>
  <input id="ff_trim_start" type="number" placeholder="trim start (s)" class="w-[150px] px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
  <input id="ff_trim_end" type="number" placeholder="trim end (s)" class="w-[150px] px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" />
  <button class="btn-chip" type="button" onclick="setWHShorts()">Auto 1080√ó1920</button>
      </div>
      <div class="row">
  <input id="ff_wm" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Watermark image path (PNG/JPG)" />
        <input id="ff_wm_file" type="file" accept="image/png,image/jpeg" class="m-1 block text-sm text-slate-300 file:mr-4 file:rounded-lg file:border-0 file:bg-violet-600 file:px-3 file:py-2 file:text-white hover:file:bg-violet-500" />
  <button class="btn-chip" onclick="uploadWatermark()">Upload</button>
  <img id="ff_wm_preview" class="wm-thumb" alt="preview" />
        <select id="ff_wm_pos" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60">
          <option value="top-left">top-left</option>
          <option value="top-right">top-right</option>
          <option value="bottom-left">bottom-left</option>
          <option value="bottom-right">bottom-right</option>
        </select>
      </div>
  <div class="row"><span id="wh_hint" class="hint"></span></div>
      <div class="row">
        <button class="btn-gradient" onclick="addToQueue()">Ajouter √† la file</button>
      </div>
      </section>

  <!-- Progression (D%/U%) et contr√¥le de la file -->
  <section id="queue" class="card glass-card p-4">
      <h2 class="mt-3">File d‚Äôattente</h2>
      <div class="row">
        <button class="btn-chip btn-chip-violet" onclick="startQueue()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline mr-1"><path d="M4 4l12 6-12 6V4z"/></svg>
          D√©marrer
        </button>
        <button class="btn-chip" onclick="pauseQueue(false)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline mr-1"><path d="M6 4h3v12H6zM11 4h3v12h-3z"/></svg>
          Reprendre
        </button>
        <button class="btn-chip" onclick="pauseQueue(true)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline mr-1"><path d="M6 4h3v12H6zM11 4h3v12h-3z"/></svg>
          Pause
        </button>
  <span class="ml-4"></span>
        <label class="flex items-center gap-1 m-1"><input type="checkbox" id="pauseN_enabled" class="accent-violet-500"> <span>Pause apr√®s</span></label>
        <input id="pauseN_value" type="number" step="1" class="w-20 px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="N"/>
  <button class="btn-chip" onclick="applyPauseN()">Appliquer</button>
  <span class="flex-1"></span>
  <button class="btn-chip" onclick="clearDone()">Vider termin√©s</button>
  <button class="btn-chip" onclick="resumeErrors()">Reprendre erreurs</button>
      </div>
      <div class="mt-2 table-wrap rounded-xl border border-white/10">
        <table class="min-w-full text-sm">
          <thead class="bg-white/5">
            <tr>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">URL</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">Titre</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">Statut</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">F%</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">D%</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">U%</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">R√©sultat</th>
              <th class="text-left px-3 py-2 font-semibold text-indigo-200">Ordre</th>
              <th class="px-3 py-2"></th>
            </tr>
          </thead>
          <tbody id="queue_body" class="divide-y divide-white/10">
            {% for it in q %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2 url-cell" title="{{ it.url }}">{{ it.url }}</td>
              <td class="px-3 py-2 wrap-cell">{{ it.title }}</td>
              <td class="px-3 py-2">
                {% set st = (it.status or '')|lower %}
                {% if 'run' in st or 'process' in st or 'upload' in st or 'download' in st %}
                  <span class="badge badge-live">{{ it.status }}</span>
                {% elif 'done' in st or 'ok' in st or 'success' in st %}
                  <span class="badge badge-blue">{{ it.status }}</span>
                {% elif 'error' in st or 'fail' in st %}
                  <span class="badge badge-muted">{{ it.status }}</span>
                {% else %}
                  <span class="badge badge-violet">{{ it.status }}</span>
                {% endif %}
                {% if it.badges %}
                  {% for b in it.badges %}
                    {% if b == 'prep' %}
                      <span class="badge badge-blue" title="Pr√©paration MP4 appliqu√©e">prep</span>
                    {% elif b == 'ffskip' %}
                      <span class="badge badge-muted" title="ffmpeg saut√© (entr√©e invalide ou trop petite)">ff-skip</span>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </td>
              <td class="px-3 py-2"><div class="bar"><div class="fill" data-f="{{ it.f_pct or 0 }}"></div></div></td>
              <td class="px-3 py-2"><div class="bar"><div class="fill" data-d="{{ it.d_pct or 0 }}"></div></div></td>
              <td class="px-3 py-2"><div class="bar"><div class="fill" data-u="{{ it.u_pct or 0 }}"></div></div></td>
              <td class="px-3 py-2 nowrap-ellipsis" title="{{ it.result }}">
                {% set rs = it.results or {} %}
                {% if rs.yt %}<span class="badge badge-blue" title="YouTube">yt</span> {{ rs.yt }} {% endif %}
                {% if rs.ig %}<span class="badge badge-violet" title="Instagram">ig</span> {{ rs.ig }} {% endif %}
                {% if rs.tt %}
                  {% if rs.tt.startswith('tt_error_') %}
                    <span class="badge" style="background:#dc2626;color:#fff;" title="{{ rs.tt }}">tt-err</span>
                  {% else %}
                    <span class="badge badge-violet" title="TikTok">tt</span> {{ rs.tt }}
                  {% endif %}
                {% endif %}
                {% if not rs or (not rs.yt and not rs.ig and not rs.tt) %}{{ it.result }}{% endif %}
              </td>
              <td class="px-3 py-2">
                <button class="btn-chip" onclick="moveItem('{{ it.iid }}','up')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>
                </button>
                <button class="btn-chip" onclick="moveItem('{{ it.iid }}','down')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                </button>
              </td>
              <td class="px-3 py-2"><button class="btn-chip" onclick="removeItem('{{ it.iid }}')" aria-label="Supprimer" title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M6 7h12v2H6zM9 9h2v8H9zm4 0h2v8h-2z"/></svg>
              </button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </section>

    <!-- Surveillance TikTok (poll) -->
  <section id="watch" class="card glass-card p-4">
      <h2 class="mt-3">Surveillance TikTok</h2>
      <div class="row">
  <input id="handle" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="URL profil TikTok ou @handle" value="{{ watch.handle }}"/>
        <input id="interval" type="number" step="1" placeholder="Intervalle (min)" value="{{ watch.interval }}" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60"/>
        <input id="quota" type="number" step="1" placeholder="Quota/poll" value="{{ watch.quota }}" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60"/>
        <button onclick="startWatch()">D√©marrer</button>
        <button class="secondary" onclick="stopWatch()">Arr√™ter</button>
      </div>
      <div class="row">
  <input id="inc_kw" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Inclure mots-cl√©s (CSV)" value="{{ ', '.join(watch.inc_kw or []) }}"/>
      </div>
      <div class="row">
  <input id="exc_kw" class="w-full px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60" placeholder="Exclure mots-cl√©s (CSV)" value="{{ ', '.join(watch.exc_kw or []) }}"/>
      </div>
      <div class="row">
        <input id="min_dur" type="number" step="1" placeholder="Dur√©e min (s)" value="{{ watch.min_dur or 0 }}" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60"/>
        <input id="max_dur" type="number" step="1" placeholder="Dur√©e max (s)" value="{{ watch.max_dur or 0 }}" class="px-3 py-2 m-1 rounded-lg border border-white/10 bg-white/5 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500/50 focus:border-violet-400/60"/>
      </div>
      <div class="mt-2 muted">√âtat: {{ 'EN COURS' if watch.running else 'ARR√äT√â' }} ‚Äî Dernier poll: {{ watch.last_poll or '‚Äî' }}</div>
      </section>

  <!-- Actions & Journal -->
  <section id="journal" class="card glass-card p-4">
      <h2 class="mt-3">Actions & Journal</h2>
      <div class="row">
        <button class="btn-gradient" onclick="testYoutubeConn()">Tester connexion YouTube</button>
  <span id="net_status" class="ml-1.5"></span>
  <span class="flex-1"></span>
        <span>Dernier ID vid√©o: <span id="last_id">‚Äî</span>
          <a id="open_last" target="_blank" class="ml-1.5 btn-chip inline-flex">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"/><path d="M5 5h7v2H7v10h10v-5h2v7H5z"/></svg>
            Ouvrir
          </a>
          <button class="secondary" onclick="copyLastId()">Copier ID</button>
        </span>
      </div>
      <div class="row mt-2">
        <span class="badge">TikTok:</span>
        <span id="tt_status" class="badge badge-muted">‚Ä¶</span>
        <button class="btn-chip" onclick="ttConnect()">Connecter</button>
        <button class="btn-chip" onclick="ttDisconnect()">D√©connecter</button>
      </div>
      <pre id="logs" class="bg-white/5 border border-white/10 p-2.5 max-h-72 overflow-auto rounded-xl"></pre>
      </section>

      <!-- Activit√© r√©cente -->
      <section id="activity" class="card">
        <h2 class="mt-3">Activit√© r√©cente</h2>
        <ul id="activity_list" class="space-y-2" style="max-height:280px; overflow:auto; padding-right:4px;"></ul>
      </section>
  </div>

    <script>
      function showToast(html, timeout=6500){
        let t = document.getElementById('t2y_toast');
        if(!t){ t = document.createElement('div'); t.id = 't2y_toast'; t.className = 'toast'; document.body.appendChild(t); }
        t.innerHTML = html + ' <span class="close" onclick="hideToast()">√ó</span>';
        requestAnimationFrame(()=>{ t.classList.add('show'); });
        if(timeout>0){ clearTimeout(window.__t2y_toast_to); window.__t2y_toast_to = setTimeout(()=>{ hideToast(); }, timeout); }
      }
      function hideToast(){ const t = document.getElementById('t2y_toast'); if(!t) return; t.classList.remove('show'); setTimeout(()=>{ if(t && t.parentNode) t.parentNode.removeChild(t); }, 300); }
      function renderStatusBadge(status){
        const st = String(status||'').toLowerCase();
        if(/run|process|upload|download|ffmpeg/.test(st)) return `<span class="badge badge-live">${status}</span>`;
        if(/done|ok|success|completed/.test(st)) return `<span class="badge badge-blue">${status}</span>`;
        if(/error|fail|abort/.test(st)) return `<span class="badge badge-muted">${status}</span>`;
        return `<span class="badge badge-violet">${status}</span>`;
      }
      function escAttr(v){ return String(v==null? '': v).replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }
      function renderStatusBadge(status){
        const st = String(status||'').toLowerCase();
        if(/run|process|upload|download|ffmpeg/.test(st)){
          return `<span class="badge badge-live">${status}</span>`;
        }
        if(/done|ok|success|completed/.test(st)){
          return `<span class="badge badge-blue">${status}</span>`;
        }
        if(/error|fail|abort/.test(st)){
          return `<span class="badge badge-muted">${status}</span>`;
        }
        return `<span class="badge badge-violet">${status}</span>`;
      }
      // ---- Profils helpers
      async function refreshProfiles(){
        const r = await fetch('/api/profiles');
        if(!r.ok) return; const j = await r.json();
        const sel = document.getElementById('prof_select'); if(!sel) return;
        const names = Array.isArray(j.names) ? j.names : [];
        sel.innerHTML = names.map(n => `<option value="${escAttr(n)}">${n}</option>`).join('');
        const sprof = document.getElementById('s_profile').value || 'default';
        if(names.includes(sprof)) sel.value = sprof;
      }
      function collectProfileFromForm(){
        const tags = (document.getElementById('q_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const playlists = (document.getElementById('q_playlists').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        return {
          privacy: document.getElementById('s_privacy').value,
          tags, playlists,
          language: document.getElementById('q_language').value,
          license: document.getElementById('q_license').value,
          madeForKids: false,
          // ffmpeg
          ff_mode: document.getElementById('ff_mode').value,
          ff_target_w: document.getElementById('ff_w').value || 1080,
          ff_target_h: document.getElementById('ff_h').value || 1920,
          ff_normalize: document.getElementById('ff_normalize').checked,
          ff_remux: document.getElementById('ff_remux').checked,
          ff_force_916: document.getElementById('ff_force_916').checked,
          ff_trim_start: document.getElementById('ff_trim_start').value,
          ff_trim_end: document.getElementById('ff_trim_end').value,
          ff_wm_path: document.getElementById('ff_wm').value,
          ff_wm_pos: document.getElementById('ff_wm_pos').value
        };
      }
      function applyProfileToForm(p){
        if(!p || typeof p !== 'object') return;
        try{
          if(p.privacy) document.getElementById('s_privacy').value = p.privacy;
          if(Array.isArray(p.tags)) document.getElementById('q_tags').value = p.tags.join(', ');
          if(Array.isArray(p.playlists)) document.getElementById('q_playlists').value = p.playlists.join(', ');
          if(p.language) document.getElementById('q_language').value = p.language;
          if(p.license) document.getElementById('q_license').value = p.license;
          // ffmpeg
          if(p.ff_mode) document.getElementById('ff_mode').value = p.ff_mode;
          if(p.ff_target_w) document.getElementById('ff_w').value = p.ff_target_w;
          if(p.ff_target_h) document.getElementById('ff_h').value = p.ff_target_h;
          if(typeof p.ff_normalize === 'boolean') document.getElementById('ff_normalize').checked = p.ff_normalize;
          if(typeof p.ff_remux === 'boolean') document.getElementById('ff_remux').checked = p.ff_remux;
          if(typeof p.ff_force_916 === 'boolean') document.getElementById('ff_force_916').checked = p.ff_force_916;
          if(p.ff_trim_start) document.getElementById('ff_trim_start').value = p.ff_trim_start;
          if(p.ff_trim_end) document.getElementById('ff_trim_end').value = p.ff_trim_end;
          if(p.ff_wm_path) document.getElementById('ff_wm').value = p.ff_wm_path;
          if(p.ff_wm_pos) document.getElementById('ff_wm_pos').value = p.ff_wm_pos;
        }catch(e){}
      }
      async function profileLoad(){
        const name = document.getElementById('prof_select').value;
        if(!name) return;
        const r = await fetch('/api/profiles/' + encodeURIComponent(name));
        if(!r.ok) return; const j = await r.json();
        applyProfileToForm(j.data);
        document.getElementById('s_profile').value = name;
      }
      async function profileSave(){
        const name = document.getElementById('prof_select').value || (document.getElementById('s_profile').value || 'default');
        const body = collectProfileFromForm();
        await fetch('/api/profiles/' + encodeURIComponent(name), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        await refreshProfiles();
      }
      async function profileDuplicate(){
        const name = document.getElementById('prof_select').value || 'default';
        const new_name = prompt('Nom du nouveau profil:', name + '_copy');
        if(!new_name) return;
        const r = await fetch(`/api/profiles/${encodeURIComponent(name)}/duplicate`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({new_name})});
        if(r.ok){ await refreshProfiles(); document.getElementById('prof_select').value = new_name; }
      }
      async function profileDelete(){
        const name = document.getElementById('prof_select').value; if(!name || name==='default') return;
        if(!confirm(`Supprimer le profil "${name}" ?`)) return;
        await fetch('/api/profiles/' + encodeURIComponent(name), {method:'DELETE'});
        await refreshProfiles();
      }
      async function profilesExport(){
        window.location.href = '/api/profiles/export';
      }
      async function profilesImport(){
        const jsonText = prompt('Coller le JSON des profils √† importer:');
        if(!jsonText) return;
        let data; try{ data = JSON.parse(jsonText); }catch(e){ alert('JSON invalide'); return; }
        const overwrite = confirm('√âcraser les profils existants portant le m√™me nom ? OK=Oui / Annuler=Non');
        await fetch('/api/profiles/import', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({data, overwrite})});
        await refreshProfiles();
      }
      
      async function refresh(){
        try{
          const r = await fetch('/api/status');
          const s = await r.json();
          // file: render rows
          const tbody = document.getElementById('queue_body');
          if (tbody && s.queue && Array.isArray(s.queue.items)){
            tbody.innerHTML = s.queue.items.map(it => {
              const iid = escAttr(it.iid||'');
              const badges = Array.isArray(it.badges) ? it.badges : [];
              const bhtml = badges.map(b => {
                if(b==='prep') return '<span class="badge badge-blue" title="Pr√©paration MP4 appliqu√©e">prep</span>';
                if(b==='ffskip') return '<span class="badge badge-muted" title="ffmpeg saut√© (entr√©e invalide ou trop petite)">ff-skip</span>';
                return '';
              }).join(' ');
              return `
              <tr class="hover:bg-white/5">
                <td class="px-3 py-2 url-cell" title="${it.url||''}">${it.url||''}</td>
                <td class="px-3 py-2 wrap-cell">${it.title||''}</td>
                <td class="px-3 py-2">${renderStatusBadge(it.status||'')} ${bhtml}</td>
                <td class="px-3 py-2"><div class=\"bar\"><div class=\"fill\" style=\"width: ${(it.f_pct||0)}%\"></div></div></td>
                <td class="px-3 py-2"><div class=\"bar\"><div class=\"fill\" style=\"width: ${(it.d_pct||0)}%\"></div></div></td>
                <td class="px-3 py-2"><div class=\"bar\"><div class=\"fill\" style=\"width: ${(it.u_pct||0)}%\"></div></div></td>
                <td class="px-3 py-2 nowrap-ellipsis" title="${it.result||''}">
                  ${(() => { const r = it.results||{}; const parts = [];
                    if(r.yt) parts.push(`<span class='badge badge-blue' title='YouTube'>yt</span> ${r.yt}`);
                    if(r.ig) parts.push(`<span class='badge badge-violet' title='Instagram'>ig</span> ${r.ig}`);
                    if(r.tt) {
                      if(typeof r.tt === 'string' && r.tt.startsWith('tt_error_')) {
                        parts.push(`<span class='badge' style='background:#dc2626;color:#fff;' title='${r.tt.replace(/'/g,'&#39;')}'>tt-err</span>`);
                      } else {
                        parts.push(`<span class='badge badge-violet' title='TikTok'>tt</span> ${r.tt}`);
                      }
                    }
                    return parts.length ? parts.join(' ') : (it.result||''); })()}
                </td>
                <td class="px-3 py-2">
                  <button class="secondary" onclick="moveItem('${iid}','up')">‚Üë</button>
                  <button class="secondary" onclick="moveItem('${iid}','down')">‚Üì</button>
                </td>
                <td class="px-3 py-2"><button class="secondary" onclick="removeItem('${iid}')" aria-label="Supprimer" title="Supprimer">üóë</button></td>
              </tr>`;
            }).join('');
          }
          // last video id
          const lid = (s.queue && s.queue.lastVideoId) ? s.queue.lastVideoId : '‚Äî';
          const elid = document.getElementById('last_id'); if(elid) elid.textContent = lid || '‚Äî';
          const open = document.getElementById('open_last'); if(open){ open.href = lid && lid !== '‚Äî' ? ('https://youtu.be/' + lid) : '#'; }
          // logs
          const lr = await fetch('/api/logs?limit=400');
          if(lr.ok){
            const lj = await lr.json();
            if(lj && Array.isArray(lj.lines)){
              const el = document.getElementById('logs');
              if(el){
                el.textContent = lj.lines.join('');
                el.scrollTop = el.scrollHeight;
              }
              const act = document.getElementById('activity_list');
              if(act){
                // Construire une petite timeline (max ~20 items)
                const items = lj.lines.slice(-20).map(line => {
                  const safe = (line||'').replace(/[<>]/g, '');
                  return `<li class="flex items-start gap-2 text-sm">
                    <span class="mt-1 inline-block w-2 h-2 rounded-full bg-accent2/80"></span>
                    <span class="text-slate-300">${safe}</span>
                  </li>`;
                }).join('');
                act.innerHTML = items;
              }
            }
          }
        }catch(e){/* ignore */}
      }
  setInterval(refresh, 1500); refresh();
      // charger param√®tres par d√©faut
      (async function(){
        const r = await fetch('/api/settings');
        if(r.ok){
          const j = await r.json();
          const s = j.settings||{};
          if(s.defaultPrivacy) document.getElementById('s_privacy').value = s.defaultPrivacy;
          if(s.defaultProfile) document.getElementById('s_profile').value = s.defaultProfile;
          if(s.defaultTimeout) document.getElementById('s_timeout').value = s.defaultTimeout;
          if(s.defaultProxy) document.getElementById('s_proxy').value = s.defaultProxy;
          if(s.defaultChunkMB) document.getElementById('s_chunk').value = s.defaultChunkMB;
          if(s.defaultRetries) document.getElementById('s_retries').value = s.defaultRetries;
        }
      })();
      async function startWatch(){ const handle = document.getElementById('handle').value.trim(); const interval = parseFloat(document.getElementById('interval').value || '10'); const quota = parseInt(document.getElementById('quota').value || '0'); const inc_kw = document.getElementById('inc_kw').value; const exc_kw = document.getElementById('exc_kw').value; const min_dur = parseInt(document.getElementById('min_dur').value || '0'); const max_dur = parseInt(document.getElementById('max_dur').value || '0'); await fetch('/api/watch/start', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({handle, interval, quota, inc_kw, exc_kw, min_dur, max_dur})}); location.reload(); }
      async function stopWatch(){
        await fetch('/api/watch/stop', {method:'POST'});
        location.reload();
      }
      async function startQueue(){ await fetch('/api/queue/start', {method:'POST'}); }
  async function pauseQueue(pause){ await fetch('/api/queue/pause', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pause})}); }
      async function clearDone(){ await fetch('/api/queue/clear_done', {method:'POST'}); refresh(); }
      async function resumeErrors(){ await fetch('/api/queue/resume_errors', {method:'POST'}); refresh(); }
      async function moveItem(iid, direction){ await fetch('/api/queue/move', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({iid, direction})}); refresh(); }
      async function removeItem(iid){ if(!iid) return; await fetch('/api/queue/remove', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({iid})}); refresh(); }
      async function applyPauseN(){
        const enabled = document.getElementById('pauseN_enabled').checked;
        const value = parseInt(document.getElementById('pauseN_value').value||'0');
        await fetch('/api/queue/pause_after_n', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({enabled, value})});
      }
      async function prefill(){ const url = document.getElementById('q_url').value.trim(); if(!url) return; const r = await fetch('/api/prefill', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url})}); if(!r.ok) return; const j = await r.json(); if(j && j.meta){ if(j.meta.title) document.getElementById('q_title').value = j.meta.title; if(j.meta.description) document.getElementById('q_desc').value = j.meta.description; if(j.meta.thumbnail){ const im = document.getElementById('thumb'); if(im){ im.src = j.meta.thumbnail; } } if(Array.isArray(j.meta.hashtags)){ const tags = (j.meta.hashtags||[]).map(t=>String(t||'').replace(/^#/,'')).filter(Boolean); document.getElementById('q_tags').value = tags.join(', '); } } }
      // Appliquer largeur des barres (rendu initial Jinja)
      (function(){
        const fFills = document.querySelectorAll('.bar .fill[data-f]');
        fFills.forEach(el => {
          const v = parseInt(el.getAttribute('data-f')||'0');
          el.style.width = Math.max(0, Math.min(100, v)) + '%';
        });
        const dFills = document.querySelectorAll('.bar .fill[data-d]');
        dFills.forEach(el => {
          const v = parseInt(el.getAttribute('data-d')||'0');
          el.style.width = Math.max(0, Math.min(100, v)) + '%';
        });
        const uFills = document.querySelectorAll('.bar .fill[data-u]');
        uFills.forEach(el => {
          const v = parseInt(el.getAttribute('data-u')||'0');
          el.style.width = Math.max(0, Math.min(100, v)) + '%';
        });
      })();
      async function addToQueue(){
        const payload = {
          url: document.getElementById('q_url').value.trim(),
          title: document.getElementById('q_title').value.trim(),
          description: document.getElementById('q_desc').value.trim(),
          privacy: document.getElementById('q_privacy').value,
          tags: document.getElementById('q_tags').value,
          categoryId: document.getElementById('q_category').value,
          defaultLanguage: document.getElementById('q_language').value,
          license: document.getElementById('q_license').value,
          playlists: document.getElementById('q_playlists').value,
          proxy: document.getElementById('q_proxy').value,
          timeout: document.getElementById('q_timeout').value,
          uploadChunkMB: document.getElementById('q_chunk').value,
          uploadMaxRetries: document.getElementById('q_retries').value,
          profile: document.getElementById('q_profile').value,
          // destinations
          dest_yt: document.getElementById('dest_yt').checked,
          dest_ig: document.getElementById('dest_ig').checked,
          dest_tt: document.getElementById('dest_tt').checked,
          // ffmpeg opts
          ff_mode: document.getElementById('ff_mode').value,
          ff_target_w: document.getElementById('ff_w').value,
          ff_target_h: document.getElementById('ff_h').value,
          ff_normalize: document.getElementById('ff_normalize').checked,
          ff_remux: document.getElementById('ff_remux').checked,
          ff_trim_start: document.getElementById('ff_trim_start').value,
          ff_trim_end: document.getElementById('ff_trim_end').value,
          ff_wm_path: document.getElementById('ff_wm').value,
          ff_wm_pos: document.getElementById('ff_wm_pos').value,
        };
        await fetch('/api/queue/add', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        document.getElementById('q_title').value='';
        document.getElementById('q_desc').value='';
        document.getElementById('q_tags').value='';
        const im = document.getElementById('thumb'); if(im){ im.removeAttribute('src'); }
        const pv = document.getElementById('ff_wm_preview'); if(pv){ pv.removeAttribute('src'); }
        const hh = document.getElementById('wh_hint'); if(hh){ hh.textContent = ''; }
        refresh();
      }
      function setWHShorts(){
        const wEl = document.getElementById('ff_w');
        const hEl = document.getElementById('ff_h');
        const force = document.getElementById('ff_force_916');
        if(wEl) wEl.value = 1080;
        if(hEl) hEl.value = 1920;
        if(force) force.checked = true;
        validateWH();
      }
      function validateWH(){
        const w = parseInt(document.getElementById('ff_w').value||'0');
        const h = parseInt(document.getElementById('ff_h').value||'0');
        const hint = document.getElementById('wh_hint');
        if(!w || !h){ if(hint) hint.textContent = ''; return; }
        const ratio = (w/h).toFixed(3);
        const is916 = Math.abs((w*1.0/h) - (9/16)) < 0.01;
        if(hint) hint.textContent = `Ratio ~ ${ratio} ${is916? '(‚âà 9:16 OK)': ''}`;
      }
      function whChanged(src){
        const auto = document.getElementById('ff_force_916').checked;
        const wEl = document.getElementById('ff_w');
        const hEl = document.getElementById('ff_h');
        let w = parseInt(wEl.value||'0');
        let h = parseInt(hEl.value||'0');
        if(auto){
          if(src==='w' && w>0){ h = Math.round(w * 16 / 9); hEl.value = h; }
          if(src==='h' && h>0){ w = Math.round(h * 9 / 16); wEl.value = w; }
        }
        validateWH();
      }
      async function uploadWatermark(){
        const f = document.getElementById('ff_wm_file');
        if(!f || !f.files || !f.files[0]){ alert('S√©lectionnez une image'); return; }
        const form = new FormData();
        form.append('file', f.files[0]);
        const r = await fetch('/api/upload/watermark', {method:'POST', body: form});
        const j = await r.json();
        if(r.ok && j && j.path){
          document.getElementById('ff_wm').value = j.path;
          const pv = document.getElementById('ff_wm_preview'); if(pv && j.url){ pv.src = j.url; }
        }
        else{ alert(j && j.error ? j.error : 'Upload √©chou√©'); }
      }
      async function saveSettings(){
        const payload = {
          defaultPrivacy: document.getElementById('s_privacy').value,
          defaultProfile: document.getElementById('s_profile').value,
          defaultTimeout: document.getElementById('s_timeout').value,
          defaultProxy: document.getElementById('s_proxy').value,
          defaultChunkMB: document.getElementById('s_chunk').value,
          defaultRetries: document.getElementById('s_retries').value,
        };
        await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      }
      async function checkFfmpeg(){
        const r = await fetch('/api/ffmpeg/status');
        if(!r.ok) return; const j = await r.json();
        const msg = j.found ? `ffmpeg OK: ${j.path} ${j.version||''}` : 'ffmpeg introuvable';
        const el = document.getElementById('logs'); if(el){ el.textContent += `\n${msg}`; el.scrollTop = el.scrollHeight; }
      }
      async function downloadDiagnostics(){ window.location.href = '/api/diagnostics'; }
      async function testYoutubeConn(){ const proxy = document.getElementById('s_proxy').value; const r = await fetch('/api/net/test?proxy=' + encodeURIComponent(proxy)); const j = await r.json(); const el = document.getElementById('net_status'); if(el){ el.textContent = j.ok ? 'Connexion OK' : ('√âchec ('+(j.status||j.error)+')'); } }
  async function loadTtStatus(){ try{ const r = await fetch('/api/tiktok/status'); if(!r.ok) return; const j = await r.json(); const el = document.getElementById('tt_status'); if(!el) return; el.className = 'badge ' + (j.connected? 'badge-blue':'badge-muted'); el.textContent = j.connected? (j.profile? ('connect√© ‚Ä¢ '+j.profile) : 'connect√©') : 'non connect√©'; }catch(e){} }
  async function ttConnect(){ const p = document.getElementById('s_profile').value||'default'; const r = await fetch('/api/tiktok/connect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({profile:p})}); if(!r.ok) return; const j = await r.json(); if(j && j.authUrl){ window.open(j.authUrl, '_blank'); } setTimeout(loadTtStatus, 500); }
  async function ttDisconnect(){ await fetch('/api/tiktok/disconnect', {method:'POST'}); loadTtStatus(); }
      async function disconnectProfile(){ const p = document.getElementById('s_profile').value||'default'; await fetch('/api/profile/disconnect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({profile:p})}); }
      async function reauthProfile(){ const p = document.getElementById('s_profile').value||'default'; await fetch('/api/profile/reauth', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({profile:p})}); }
      async function copyLastId(){ const t = document.getElementById('last_id').textContent||''; if(!t || t==='‚Äî') return; try{ await navigator.clipboard.writeText(t);}catch(e){} }
      async function updateCssBadge(){ try{ const r = await fetch('/api/css/health'); if(!r.ok) return; const j = await r.json(); const el = document.getElementById('css_badge'); if(!el) return; if(!j.exists){ el.textContent = 'CSS: missing'; el.className = 'chip badge-muted'; return; } if(j.compiledOk){ el.textContent = 'CSS: Tailwind'; el.className = 'chip badge-blue'; return; } if(j.looksFallback){ el.textContent = 'CSS: fallback'; el.className = 'chip badge-violet'; return; } el.textContent = 'CSS: unknown'; el.className = 'chip'; }catch(e){} }
      updateCssBadge(); setInterval(updateCssBadge, 5000);
  loadTtStatus();
      (function(){ try{ const seen = sessionStorage.getItem('t2y_toast_run'); if(!seen){ const url = window.location.origin; showToast(`Application d√©marr√©e: <a href="${url}" target="_blank">${url}</a>`); sessionStorage.setItem('t2y_toast_run','1'); } }catch(e){} })();

      // Activer la chip de section visible (Harbor-like)
      (function(){
        const chips = Array.from(document.querySelectorAll('.subnav-inner a[href^="#"]'));
        const sections = chips.map(a => document.querySelector(a.getAttribute('href'))).filter(Boolean);
        if(!('IntersectionObserver' in window) || !sections.length) return;
        const io = new IntersectionObserver(entries => {
          const visible = entries.filter(e => e.isIntersecting).sort((a,b)=> b.intersectionRatio - a.intersectionRatio)[0];
          if(!visible) return;
          const id = '#' + visible.target.id;
          chips.forEach(c => c.classList.toggle('chip-active', c.getAttribute('href')===id));
        }, {rootMargin:'-15% 0px -70% 0px', threshold:[0,0.2,0.5,0.8,1]});
        sections.forEach(s => io.observe(s));
      })();
    </script>
  </body>
</html>
